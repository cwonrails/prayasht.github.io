<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">Kickback With Koa &amp; Webpack - effulgence // prayash thapa</title><meta name="robots" content="index, follow"/><meta name="author" content="Siddharth Jain"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="@f0rr0"/><meta property="fb:app_id" content="532441146961582"/><meta property="og:url" content="https://yuppi.es/blog/kickback-with-koa-webpack/"/><meta property="og:site_name" content="Yuppies"/><meta data-react-helmet="true" name="description" content="Build a KoaJS server with ES7 async/await. Hot patch it without restarting via Webpack Hot Module Replacement. Achieve DX nirvana."/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Kickback With Koa &amp; Webpack - effulgence // prayash thapa"/><meta data-react-helmet="true" property="og:image" content="https://yuppi.es//38efebf2bc5832b39113314d2fd9cc07.jpg"/><meta data-react-helmet="true" property="article:author" content="https://facebook.com/f0rr0"/><meta data-react-helmet="true" property="article:published_time" content="2016-06-28T00:00:00-06:00"/><meta data-react-helmet="true" name="twitter:description" content="Build a KoaJS server with ES7 async/await. Hot patch it without restarting via Webpack Hot Module Replacement. Achieve DX nirvana."/><meta data-react-helmet="true" name="twitter:title" content="Kickback With Koa &amp; Webpack - effulgence // prayash thapa"/><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet"/><style>*{margin:0;padding:0;border:none;box-sizing:border-box}article,aside,footer,header,nav,section{display:block}@font-face{font-family:Neuzeit-Book;src:url(/31a5a41cd6cff402d3cc6bda4465e155.woff2) format("woff2"),url(/c506d6b24ddd6d6a415b040bedcc2c5d.woff) format("woff"),url(/6d3d124d492156dfc479741630f99312.ttf) format("ttf")}.bold{font-weight:bolder}body{font-family:Neuzeit-Book,Helvetica Neue,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;font-size:14px;line-height:1.4em;font-weight:400;color:#282828;letter-spacing:.02em;background:#ebebeb}body header#header h1 a,body header#header h2,body header#header nav a{transition:color .7s ease;transition:font-family .7s ease}body header#header .logo{text-align:center}h3,p{font-size:14px;line-height:1.4em;font-family:Neuzeit-Book,Helvetica Neue,Helvetica,Arial,sans-serif;font-weight:400;color:#282828!important;letter-spacing:.02em}h2{margin-top:0}h3{letter-spacing:.06em}p{margin-bottom:1em}a{color:#282828;text-decoration:none}.blog-page{margin-bottom:40px}.blog-page h1{font-size:responsive 20px 36px;margin-top:0}.blog-page p{font-size:16px;line-height:26px;margin-bottom:26px}@media (max-width:900px){.blog-single .footer,.blog-single .text{padding:0 15px}}header#header{position:relative;padding-top:30px}header#header a{color:#282828}header#header .site-title{display:none}header#header .logo{display:block;margin:0 auto;width:100%;z-index:9999}header#header .logo :active,header#header .logo:hover{opacity:.6}header#header .logo.hide{display:none}header#header .logo h1{text-align:center;margin:0;font-size:1.5em;font-weight:500;color:#202020;opacity:.66;padding:1em}#emblemContainer{width:80%;margin:0 auto}#emblemContainer svg#main{display:block;position:relative;margin:0 auto;-webkit-user-select:none}@media (min-width:300px) and (max-width:767px){#emblemContainer svg#main{width:100%}}#emblemContainer svg#main path{cursor:pointer;transition:fill-opacity .5s}#emblemContainer svg#main path:hover{fill-opacity:.5}#emblemContainer #behance{fill:#0955ff}#emblemContainer #blog{fill:#c12354}#emblemContainer #facebook{fill:#3b5999}#emblemContainer #soundcloud{fill:#cb5923}#emblemContainer #twitter{fill:#55aded}#emblemContainer #youtube{fill:#cd181f}#emblemContainer .swoosh{animation:swoosh-animation 5s linear both}@keyframes swoosh-animation{0%{transform:matrix(1,0,0,1,-700,0);opacity:0}2.5%{transform:matrix(1,0,0,1,-456.546,0)}4.9%{transform:matrix(1,0,0,1,-298.898,0)}9.81%{transform:matrix(1,0,0,1,-120.56,0)}14.71%{transform:matrix(1,0,0,1,-45.442,0);opacity:.5}19.62%{transform:matrix(1,0,0,1,-15.608,0)}29.43%{transform:matrix(1,0,0,1,-.912,0)}59.14%{transform:matrix(1,0,0,1,.264,0);opacity:1}to{transform:matrix(1,0,0,1,0,0)}}</style></head><body class="container"><div id="react-mount"><main data-reactroot="" data-reactid="1" data-react-checksum="-423008387"><header id="header" data-reactid="2"><div class="logo" data-reactid="3"><h1 data-reactid="4"><a href="/" data-reactid="5">prayash thapa</a></h1></div></header><section class="content" data-reactid="6"><!-- react-empty: 7 --><article class="blog-body" data-reactid="8"><header class="blog-header" data-reactid="9"><h2 data-reactid="10">Kickback With Koa &amp; Webpack</h2><div data-reactid="11"><time data-reactid="12">June 28, 2016</time><!-- react-text: 13 --> ¬∑ <!-- /react-text --><!-- react-text: 14 -->2502<!-- /react-text --><!-- react-text: 15 --> words ¬∑ <!-- /react-text --><!-- react-text: 16 -->13 min read<!-- /react-text --></div></header><div class="post-content" data-reactid="17"><figure class="full-width"><img src="./banner.png" alt="Written at Kerckhoff Coffee House ~ LA Westside"><figcaption>Written at Kerckhoff Coffee House ~ LA Westside</figcaption></figure>
<h4 id="yet-another-javascript-framework"><a class="header-anchor" href="#yet-another-javascript-framework" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Yet Another JavaScript Framework?</h4>
<p><a href="https://nodejs.org/en/about/" target="_blank" rel="noopener noreferrer">Node.js</a> itself offers a
<a href="https://nodejs.org/docs/latest/doc/api/http.html#http_http" target="_blank" rel="noopener noreferrer">http</a> module which
exposes methods that facilitate creating HTTP clients and servers. However, in
order to support the full spectrum of possible HTTP applications, Node.js‚Äô HTTP
API is very low-level. This is where frameworks like
<a href="http://expressjs.com/" target="_blank" rel="noopener noreferrer">Express</a>, <a href="http://hapijs.com/" target="_blank" rel="noopener noreferrer">Hapi</a>,
<a href="http://restify.com/" target="_blank" rel="noopener noreferrer">Restify</a>, and <a href="http://koajs.com/" target="_blank" rel="noopener noreferrer">Koa</a> come in.</p>
<h4 id="quick-word-on-express"><a class="header-anchor" href="#quick-word-on-express" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Quick Word on Express</h4>
<p>Express is undoubtedly the most popular Node.js application framework in use
today. A quick check reveals that 10434 packages on
<a href="https://www.npmjs.com/" target="_blank" rel="noopener noreferrer">npm</a> list Express as a dependency. This number probably
increases by the day. The initial commit for Express was made in 2009 by <a href="https://medium.com/u/bbb3c7ccb0a0" target="_blank" rel="noopener noreferrer">TJ
Holowaychuk</a> and 660 commits later, version
0.0.1 was released. Express ownership was transferred to StrongLoop, in 2014,
which eventually got acquired by IBM. The current lead maintainer of the project
<a href="https://github.com/expressjs/express/issues/2844#issuecomment-173758490" target="_blank" rel="noopener noreferrer">did not have many nice things to
say</a>
about StrongLoop/IBM.</p>
<h4 id="aloha-koa"><a class="header-anchor" href="#aloha-koa" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Aloha Koa</h4>
<p>The initial commit for Koa was 3 years ago, by none other than the man himself ‚Äî
<a href="https://medium.com/u/bbb3c7ccb0a0" target="_blank" rel="noopener noreferrer">TJ Holowaychuk</a>. He described it back then
as:</p>
<blockquote>
<p>‚ÄúExpressive middleware for node.js using generators via
<a href="https://github.com/tj/co" target="_blank" rel="noopener noreferrer">co</a> to make writing web applications and REST APIs
more enjoyable to write‚Äù.</p>
</blockquote>
<p>Basically, Koa allows you to do away with the callback pattern and makes
error-handling more efficient. Everything in Koa is middleware which makes
writing code more intuitive and easy (at least for me). Koa accomplished this
with <a href="https://davidwalsh.name/es6-generators" target="_blank" rel="noopener noreferrer">generators</a> which were
introduced in <a href="http://www.ecma-international.org/ecma-262/6.0/" target="_blank" rel="noopener noreferrer">ES2015 (ES6)</a>.
This can be run natively in Node.js version 0.11+ (with the <code>--harmony</code> flag).
As of <a href="https://github.com/koajs/koa/blob/v2.x/History.md#200-alpha1--2015-10-22" target="_blank" rel="noopener noreferrer">version
2.0.0-alpha.1</a>,
however, the codebase was refactored to <a href="https://tc39.github.io/ecmascript-asyncawait/" target="_blank" rel="noopener noreferrer">async
functions</a> (<a href="https://tc39.github.io/ecma262/2016/" target="_blank" rel="noopener noreferrer">ES2016 or
ES7</a>) in favor of generators.
Unfortunately, these are <a href="https://bugs.chromium.org/p/v8/issues/detail?id=4483" target="_blank" rel="noopener noreferrer">not
supported</a> natively in
<a href="https://developers.google.com/v8/" target="_blank" rel="noopener noreferrer">V8</a> (underlying engine behind the Node.js
runtime) yet.</p>
<h4 id="tools-of-the-trade"><a class="header-anchor" href="#tools-of-the-trade" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Tools of the Trade</h4>
<p>Since Node.js (V8) does not support <code>async</code> functions natively, we will use
<a href="https://babeljs.io/" target="_blank" rel="noopener noreferrer">Babel</a> to transpile them. JavaScript, as a language, is
constantly evolving with new specs and proposals coming out all the time. Babel
allows us to use these features years before they are available everywhere.</p>
<blockquote>
<p>Babel does this by compiling down JavaScript code written with the latest
standards into a version that will work in today‚Äôs environments. This process is
known as source-to-source compiling aka transpiling.</p>
</blockquote>
<p>To build our application, we will use the <a href="https://webpack.github.io/" target="_blank" rel="noopener noreferrer">Webpack</a>
module bundler which provides an infrastructure for building and transforming
modules. It is discussed in detail in the subsequent sections.</p>
<h4 id="talk-is-cheap-show-me-the-code"><a class="header-anchor" href="#talk-is-cheap-show-me-the-code" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Talk is Cheap. Show Me the Code.</h4>
<p>The final GitHub repository is linked <a href="https://github.com/f0rr0/koa-webpack-boilerplate" target="_blank" rel="noopener noreferrer">here</a>. Before you begin hacking, make sure you have the latest version of Node.js
<a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer">installed</a>. I prefer to use
<a href="https://github.com/tj/n" target="_blank" rel="noopener noreferrer">n</a> to interactively manage Node.js versions. (While
writing this, I discovered that the author of ‚Äôn‚Äô is <a href="https://medium.com/u/bbb3c7ccb0a0" target="_blank" rel="noopener noreferrer">TJ
Holowaychuk</a> yet again.)</p>
<pre><code class="language-sh">sudo npm cache clean <span class="hljs-_">-f</span>
sudo npm install -g n
sudo n latest
</code></pre>
<p>To use some npm commands without <code>sudo</code> you might have to <a href="https://docs.npmjs.com/getting-started/fixing-npm-permissions" target="_blank" rel="noopener noreferrer">fix
permissions</a>.</p>
<h4 id="boilerplate-for-boilerplate"><a class="header-anchor" href="#boilerplate-for-boilerplate" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Boilerplate for Boilerplate</h4>
<p>We need to set up a minimal NPM package with a <code>package.json</code> file, a directory
for source, and certain essential files for our development tools.</p>
<figure><img src="./dirstructure.png" alt=""></figure>
<p>Go ahead and clone the final repository to your machine to build the minimal
server from source.</p>
<pre><code class="language-sh">git <span class="hljs-built_in">clone</span> https://github.com/f0rr0/koa-webpack-boilerplate
<span class="hljs-built_in">cd</span> koa-webpack-boilerplate
npm install
npm run build:prod
npm start
</code></pre>
<p>If you want to be articulate and follow from scratch, the following GIF will help:</p>
<figure><img src="./bootstrap.gif" alt=""></figure>
<h4 id="unbundling-webpack"><a class="header-anchor" href="#unbundling-webpack" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Unbundling Webpack</h4>
<p>Webpack was authored by JavaScript superhero <a href="https://github.com/sokra" target="_blank" rel="noopener noreferrer">Tobias
Koppers</a>. It is used in the
<a href="http://stackshare.io/webpack/in-stacks#/" target="_blank" rel="noopener noreferrer">wild</a> at Pinterest, Hipmunk,
Soundcloud and Typeform among others. It is different from other build tools
(<a href="http://gruntjs.com/" target="_blank" rel="noopener noreferrer">Grunt</a>, <a href="http://gulpjs.com/" target="_blank" rel="noopener noreferrer">Gulp</a>,
<a href="http://brunch.io/" target="_blank" rel="noopener noreferrer">Brunch</a> etc.), that you might be familiar with, since it
does <strong>more</strong> than watching a path and running tasks on files.</p>
<blockquote>
<p>Webpack roams over your application source code, looking for import/require
statements, building a dependency graph, and emitting one (or more) <em>bundles</em>
for the web (<a href="https://webpack.github.io/docs/configuration.html#target" target="_blank" rel="noopener noreferrer">or other
targets</a>).</p>
</blockquote>
<figure><img src="./webpack.png" alt=""></figure>
<p>It may seem like you can use webpack with only JavaScript modules but that is
not true. With appropriate webpack
<a href="https://webpack.github.io/docs/loaders.html" target="_blank" rel="noopener noreferrer">loaders</a>, you can bundle any
file-type and pre-process it. Basically, what this means is, you can do the
following in your front-end application with the
<a href="https://github.com/webpack/css-loader" target="_blank" rel="noopener noreferrer">css-loader</a>:</p>
<pre><code class="language-js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'css!./styles/main.css'</span>);
</code></pre>
<p>If this does not make you run naked in the streets, then I don‚Äôt know what will.
You can even chain loaders to process files on the fly, like so:</p>
<pre><code class="language-js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'style!css!sass!./styles/main.sass'</span>);
</code></pre>
<p>This one-liner appropriately parses the SASS file to CSS and injects it into the DOM in a style tag. To learn more about webpack, read <a href="https://medium.com/u/3b799f227b58" target="_blank" rel="noopener noreferrer">Pete Hunt</a>‚Äôs <a href="https://github.com/petehunt/webpack-howto" target="_blank" rel="noopener noreferrer">webpack-howto</a>.</p>
<p>When used from the CLI, webpack looks for a configuration file named <code>webpack.config.js</code> in the directory from where webpack was invoked. You can also supply your config file using the <code>--config</code> option from the CLI. So let‚Äôs install webpack and set up the config file for our repository.</p>
<p>Note ‚Äî You can view and install specific <code>dist-tags</code> for a package on <code>npm</code> like so:</p>
<pre><code class="language-sh">npm view &lt;package-name&gt; dist-tags
npm install &lt;package-name&gt;@&lt;dist-tag&gt;
</code></pre>
<p>In the root directory of your repository:</p>
<pre><code class="language-sh">npm install -D webpack@beta
</code></pre>
<p>This installs webpack as a <strong>development dependency</strong> to your package. Beginning from version 2+, the webpack config file can export a function which returns the configuration. The function is called by the CLI and the value passed via <code>--env</code> from the CLI is passed to the configuration function. Our minimal <code>webpack.config.js</code> will look like so:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> { resolve } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> { dependencies } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./package.json'</span>);
<span class="hljs-keyword">const</span> BabiliPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"babili-webpack-plugin"</span>);

<span class="hljs-keyword">const</span> nodeModules = {};

<span class="hljs-built_in">Object</span>
    .keys(dependencies)
    .forEach(<span class="hljs-function">(<span class="hljs-params">mod</span>) =&gt;</span> {
     nodeModules[mod] = <span class="hljs-string">`commonjs <span class="hljs-subst">${mod}</span>`</span>;
    });

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">env = { dev: <span class="hljs-literal">true</span> }</span>) =&gt;</span> ({
    <span class="hljs-attr">context</span>: resolve(__dirname, <span class="hljs-string">'./src'</span>),
    <span class="hljs-attr">entry</span>: {
     <span class="hljs-attr">server</span>: env.prod ? <span class="hljs-string">'./index.js'</span> : [<span class="hljs-string">'webpack/hot/poll?1000'</span>, <span class="hljs-string">'./index.js'</span>]
    },
    <span class="hljs-attr">target</span>: <span class="hljs-string">'node'</span>,
    <span class="hljs-attr">output</span>: {
     <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].js'</span>,
     <span class="hljs-attr">path</span>: resolve(__dirname, <span class="hljs-string">'./build'</span>),
     <span class="hljs-attr">pathInfo</span>: !env.prod
    },
    <span class="hljs-attr">devtool</span>: env.prod ? <span class="hljs-string">'source-map'</span> : <span class="hljs-string">'eval'</span>,
    <span class="hljs-attr">module</span>: {
     <span class="hljs-attr">loaders</span>: [
       {
         <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
         <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
         <span class="hljs-attr">loaders</span>: [
           <span class="hljs-string">'babel-loader'</span>
         ]
       }
     ]
    },
    <span class="hljs-attr">plugins</span>: env.prod ? [
      <span class="hljs-keyword">new</span> BabiliPlugin()
    ] : [],
    <span class="hljs-attr">externals</span>: nodeModules
});
</code></pre>
<p>The various configuration options are well documented
<a href="http://webpack.github.io/docs/configuration.html#configuration-object-content" target="_blank" rel="noopener noreferrer">here</a>.
I‚Äôll explain a couple of quirks related to a non-browser environment below:</p>
<ul>
<li><strong>externals:</strong> When writing a server and bundling it with webpack, we don‚Äôt want our dependencies to be resolved by webpack. Instead, they will become the dependencies of the bundle we generate. To accomplish this, we pull our dependencies from the <code>package.json</code> file and prefix them with <code>commonjs</code>. The Webpack generated import code for a prefixed fictional dependency named <code>xyz</code> will then look like so:</li>
</ul>
<pre><code class="language-js"><span class="hljs-built_in">module</span>.exports = <span class="hljs-built_in">require</span>(<span class="hljs-string">"xyz"</span>);
</code></pre>
<p>To ensure that this behaviour is consistent, install dependencies with the <code>-S</code>
or <code>--save</code> option.</p>
<ul>
<li><strong>target:</strong> Setting the target for our bundle to <em>node</em> compiles our modules to be run in a Node.js like environment. What this does is essentially the same as above. It prepends all native modules available in the current Node.js environment with <code>commonjs</code>. Internally, the names of all such modules available to the current process are obtained by:</li>
</ul>
<pre><code class="language-sh">process.binding(<span class="hljs-string">"natives"</span>);
</code></pre>
<p>This returns an object with all the native modules like <code>dns</code>, <code>domain</code>, <code>events</code>, <code>fs</code>, <code>http</code> etc.</p>
<h4 id="dabble-in-babel"><a class="header-anchor" href="#dabble-in-babel" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Dabble in Babel</h4>
<p>Babel is used in the <a href="https://babeljs.io/users/" target="_blank" rel="noopener noreferrer">wild</a> by the likes of Facebook, Netflix, Airbnb and Yahoo. As mentioned earlier, we will use Babel to transpile our ES6/7 code. This is accomplished from within webpack via the <code>babel-loader</code>. Our config looks for files ending in <code>.js</code> in the <code>./src</code> directory and loads them with <code>babel-loader</code>. Before you can use it though, you need to install it:</p>
<pre><code class="language-sh">npm install -D babel-loader babel-core
</code></pre>
<p>This installs <code>babel-loader</code>, again, as a <strong>development dependency</strong>. <code>babel-loader</code> in turn lists <code>babel-core</code> as its peer dependency which needs to be installed. This is the babel compiler core which exposes the Node.js API. At a high level, Babel runs in three stages: parsing, transforming, and generation. Out of the box, Babel does not transform anything. It just parses code and spits it out exactly the same. To make Babel transform code, we need to (you guessed it!) install plugins.</p>
<p>If you updated your Node.js installation to the latest version, as mentioned earlier, you‚Äôd have probably ended up with 6.2.2+ which supports <a href="http://node.green/" target="_blank" rel="noopener noreferrer">96%</a> of the ES2015(ES6) features. V8 hasn‚Äôt landed <a href="https://bugs.chromium.org/p/v8/issues/detail?id=1569" target="_blank" rel="noopener noreferrer">support</a> for ES6 native modules yet but Webpack 2+ takes care of that for us. It understands native ES6 modules which are statically analyzable. This helps in getting rid of extraneous exports from our build aka dead code elimination. Webpack accomplishes this with <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html" target="_blank" rel="noopener noreferrer">tree-shaking</a>. Sweet! So we just need to worry about those <em>async</em> functions that Node.js 6.2.2 doesn‚Äôt understand.</p>
<p>The plugin we need is <a href="http://babeljs.io/docs/plugins/transform-async-to-generator/" target="_blank" rel="noopener noreferrer">babel-plugin-transform-async-to-generator</a>. The name is more than self-explanatory. Babel can be configured to use these plugins via the <code>.babelrc</code> file which lives in the root of our repository. Our tiny <code>.babelrc</code> file looks like so:</p>
<pre><code class="language-json5">{
  <span class="hljs-attr">"plugins"</span>: [<span class="hljs-string">"transform-async-to-generator"</span>]
}
</code></pre>
<p>Obviously, it needs to be installed as a <strong>development dependency</strong> before you
can use it:</p>
<pre><code class="language-sh">npm install -D babel-plugin-transform-async-to-generator
</code></pre>
<h4 id="catch-em-all-with-koa"><a class="header-anchor" href="#catch-em-all-with-koa" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Catch ‚Äôem All With Koa</h4>
<p>With our build tools in place, we can start writing the server finally. As mentioned earlier, Koa is a very minimal framework and does not offer much out of the box. Everything in Koa is middleware and there are quite a few of them. We will be using Koa 2 which can be installed with the <code>next</code> dist-tag. Go ahead and install Koa and a couple of middleware like so:</p>
<pre><code class="language-sh">npm install -S koa@next koa-route@next koa-logger@next
</code></pre>
<p>For the purpose of this article, we will be mocking a database with the <a href="https://pokeapi.co/" target="_blank" rel="noopener noreferrer">Pokeapi</a>. Since Koa expects <code>xyz</code> to return a Promise in all <code>await xyz</code> expressions, we will make use of <a href="https://github.com/PokeAPI/pokedex-promise-v2" target="_blank" rel="noopener noreferrer">pokedex-promise-v2</a> which is simply a Promise based wrapper for the Pokeapi. Install it like so:</p>
<pre><code class="language-sh">npm install -S pokedex-promise-v2
</code></pre>
<p>We will abstract our database logic into separate modules. Go ahead and create
two new files in the <code>./src</code> directory.</p>
<pre><code class="language-sh"><span class="hljs-built_in">cd</span> src
touch pokemondb.js stats.js
</code></pre>
<ul>
<li><strong>pokemondb.js</strong> just exports a function that takes a string as an argument
and returns a Promise.</li>
</ul>
<pre><code class="language-js"><span class="hljs-keyword">import</span> Pokedex <span class="hljs-keyword">from</span> <span class="hljs-string">'pokedex-promise-v2'</span>;

<span class="hljs-keyword">const</span> P = <span class="hljs-keyword">new</span> Pokedex();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span> (<span class="hljs-params">pokemon</span>) </span>{
   <span class="hljs-keyword">return</span> P.getPokemonByName(pokemon);
};
</code></pre>
<ul>
<li><strong>stats.js</strong> also exports a function that takes an object as an argument and
return a string.</li>
</ul>
<pre><code class="language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stats</span> (<span class="hljs-params">data</span>) </span>{
   <span class="hljs-keyword">return</span> (
      <span class="hljs-string">`
      NAME   : <span class="hljs-subst">${data.name}</span>
      HEIGHT : <span class="hljs-subst">${data.height}</span>
      WEIGHT : <span class="hljs-subst">${data.weight}</span>
      BASE XP: <span class="hljs-subst">${data.base_experience}</span>
      `</span>
   );
}
</code></pre>
<p>With our mock database and helper method in place, we can go ahead and consume
it in our server. The <code>index.js</code> looks like so:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> get <span class="hljs-keyword">from</span> <span class="hljs-string">'./pokemondb'</span>;
<span class="hljs-keyword">import</span> stats <span class="hljs-keyword">from</span> <span class="hljs-string">'./stats'</span>;
<span class="hljs-keyword">import</span> Koa <span class="hljs-keyword">from</span> <span class="hljs-string">'koa'</span>;
<span class="hljs-keyword">import</span> route <span class="hljs-keyword">from</span> <span class="hljs-string">'koa-route'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'koa-logger'</span>;

<span class="hljs-keyword">const</span> getPokemonFromAPI = <span class="hljs-keyword">async</span> (ctx, name) =&gt; {
  <span class="hljs-keyword">try</span> {
   <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> get(name);
   ctx.body = stats(data);
  } <span class="hljs-keyword">catch</span> (err) {
    ctx.throw(<span class="hljs-number">404</span>, err.error.detail);
  }
};

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa();
app.use(logger())
   .use(route.get(<span class="hljs-string">'/:name'</span>, getPokemonFromAPI))
   .listen(<span class="hljs-number">8000</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Listening on Port 8000'</span>);
</code></pre>
<p>The main point of interest here is the asynchronous <code>getPokemonFromAPI</code>
function. If you have done asynchronous programming in JavaScript before, you
must be aware of the <a href="http://callbackhell.com/" target="_blank" rel="noopener noreferrer">callback pattern and the problems it
brings</a>. If that is indeed the case, this function
should make you shed tears of joy. Note how this idiom lets us handle errors
gracefully in a try-catch block.</p>
<p>We will be using some neat npm run scripts to build and start our server.</p>
<pre><code class="language-sh"><span class="hljs-string">'scripts'</span>: {
  <span class="hljs-string">'clean'</span>: <span class="hljs-string">'rm -rf ./build'</span>,
  <span class="hljs-string">'build:prod'</span>: <span class="hljs-string">'npm run clean &amp;&amp; `npm bin`/webpack --env.prod'</span>,
  <span class="hljs-string">'watch'</span>: <span class="hljs-string">'npm run clean &amp;&amp; `npm bin`/webpack --watch --verbose'</span>,
  <span class="hljs-string">'start'</span>: <span class="hljs-string">'node ./build/server.js'</span>
}
</code></pre>
<p>Besides <code>start</code> and <code>clean</code>, which are trivial, we will use <code>build:prod</code> to make
a production build by passing <code>prod</code> via <code>--env</code> as mentioned earlier.</p>
<p>Go ahead and run the following in the root of your repository and open
<code>localhost:8000</code> in your browser.</p>
<pre><code class="language-sh">npm run build:prod
npm start
</code></pre>
<p>Well, there isn‚Äôt much to see because our server returned a 404.</p>
<figure><img src="./404.png" alt="Oh no!"><figcaption>Oh no!</figcaption></figure>
<p>This is understandable since we don‚Äôt have a route handler attached to our base
URL: <code>‚Äò/‚Äô</code>. This prompts Koa to return it‚Äôs default 404 message. Go ahead and
fix this by adding that route-handler to our <code>index.js</code> file.</p>
<figure><img src="./routehandler.png" alt=""></figure>
<p>Before you can see these changes reflected, you need to build the bundle again.
This is a bummer. We want our bundle to be regenerated every time we make
changes to our source files. Our <code>watch</code> script takes care of that by running
Webpack in development mode with the <code>--watch</code> option. Webpack will now watch
our files and generate a new bundle when we save changes. Run the <code>watch</code> script
like so:</p>
<pre><code class="language-sh">npm run watch
</code></pre>
<p>Webpack won‚Äôt exit since it keeps watching the files. Open a new shell in the
root of your repository to start the server.</p>
<pre><code class="language-sh">npm start <span class="hljs-comment"># in new shell tab</span>
</code></pre>
<p>If you see an error like:</p>
<pre><code class="language-sh">Error: listen EADDRINUSE :::8000
</code></pre>
<p>Make sure you exit all currently running servers (Ctrl+C) before starting a
new one. Refresh your browser and you should see:</p>
<figure><img src="./catchemall.png" alt=""></figure>
<p>We can get stats for any Pokemon by pointing our browser to the respective name
like so:</p>
<figure><img src="./stats.png" alt=""></figure>
<h4 id="do-you-even-hmr"><a class="header-anchor" href="#do-you-even-hmr" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Do You Even HMR?</h4>
<p>If you play around with what we have so far, you‚Äôll tend to notice that our workflow is still a little complicated. We need to manually restart our server whenever we make changes since a new bundle is generated. To get past that we may use a process manager (<a href="http://pm2.keymetrics.io/" target="_blank" rel="noopener noreferrer">pm2</a>, <a href="http://nodemon.io/" target="_blank" rel="noopener noreferrer">nodemon</a>, <a href="http://strong-pm.io/" target="_blank" rel="noopener noreferrer">StrongLoopPM</a>) to watch our files and trigger a webpack build before restarting our server. This definitely removes the hassle of doing it manually. However, it works well if we are not doing anything stateful or don‚Äôt care about losing state in our server code. Go ahead and take a look at <a href="https://medium.com/u/a3a8af6addc1" target="_blank" rel="noopener noreferrer">Dan Abramov</a>‚Äôs <a href="https://gaearon.github.io/react-hot-loader/" target="_blank" rel="noopener noreferrer">react-hot-loader</a> if this doesn‚Äôt make sense. Let us leverage Webpack‚Äôs <a href="https://webpack.github.io/docs/hot-module-replacement.html" target="_blank" rel="noopener noreferrer">Hot Module Replacement</a> API to hot patch our server side code. For now, we will restrict ourselves to the development environment.</p>
<p>Note that we are currently using <a href="https://github.com/webpack/webpack/blob/master/hot/poll.js" target="_blank" rel="noopener noreferrer">webpack/hot/poll</a> which polls the Node.js filestream (<code>fs</code>) every 1000 ms. In production we might want to use the more efficient <a href="https://github.com/webpack/webpack/blob/master/hot/signal.js" target="_blank" rel="noopener noreferrer">webpack/hot/signal</a> which listens on process events to check for updates. Creating a separate directory for the records Webpack will generate should also be a good idea.</p>
<p>The watch script needs to be modified to enable HMR. This can also be done by
using the <code>HotModuleReplacementPlugin</code> but don‚Äôt use both.</p>
<pre><code class="language-sh"><span class="hljs-string">'watch'</span>: <span class="hljs-string">'npm run clean &amp;&amp; `npm bin`/webpack --env.dev --watch -- verbose --hot'</span>
</code></pre>
<p>We don‚Äôt need to do much to handle the updated dependencies in our main
<code>index.js</code> file since we are using ES6 modules which are static in nature. The
following would suffice:</p>
<figure><img src="./hmr.png" alt=""></figure>
<p>Go ahead and run the <code>watch</code> script followed by the <code>start</code> script in another
tab as before. Make changes to the <code>stats.js</code> module and refresh your browser to
see them live <strong>without restarting the server</strong>. The GIF below illustrates this
in the terminal:</p>
<figure><img src="./final.gif" alt=""></figure>
<h4 id="fin"><a class="header-anchor" href="#fin" aria-hidden="true" target="_blank" rel="noopener noreferrer">¬ß</a> Fin?</h4>
<p>HMR is theoretically possible in production but has not been tested enough. It
is better to stick to a process manager when in production. On the development
end too however, we can take it one step further by handling the case where a
hot update fails or aborts. The server should appropriately restart in that
instance. Koa apps can be tested fluently with
<a href="https://github.com/visionmedia/supertest" target="_blank" rel="noopener noreferrer">supertest</a> which this repository will
implement soon.</p>
<p>Originally <img class="emoji" draggable="false" alt="üìù" src="https://twemoji.maxcdn.com/2/svg/1f4dd.svg"> on <a href="https://medium.com/@f0rr0/kickback-with-koa-webpack-a51d7e5d7911" target="_blank" rel="noopener noreferrer">Medium</a>.</p>
</div></article><aside class="post-footer" data-reactid="18"><ul data-reactid="19"><li data-reactid="20"><div class="SocialMediaShareButton SocialMediaShareButton--twitter share-icons" data-reactid="21"><div style="width:32px;height:32px;" data-reactid="22"><svg viewBox="0 0 64 64" fill="white" width="32" height="32" class="social-icon social-icon--twitter " data-reactid="23"><g data-reactid="24"><circle cx="32" cy="32" r="31" fill="#00aced" data-reactid="25"></circle></g><g data-reactid="26"><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" data-reactid="27"></path></g></svg></div></div></li><li data-reactid="28"><div class="SocialMediaShareButton SocialMediaShareButton--facebook share-icons" data-reactid="29"><div style="width:32px;height:32px;" data-reactid="30"><svg viewBox="0 0 64 64" fill="white" width="32" height="32" class="social-icon social-icon--facebook " data-reactid="31"><g data-reactid="32"><circle cx="32" cy="32" r="31" fill="#3b5998" data-reactid="33"></circle></g><g data-reactid="34"><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" data-reactid="35"></path></g></svg></div></div></li></ul><article data-reactid="36"><header data-reactid="37"><h4 data-reactid="38">Read Next</h4></header><ul data-reactid="39"><li data-reactid="40"><a href="/blog/interviewing-with-housing-com/" data-reactid="41">Interviewing with Housing.com</a><!-- react-text: 42 --> ¬∑ <!-- /react-text --><small data-reactid="43">6 min read</small><p data-reactid="44"><small data-reactid="45">My experience and lessons learnt from interviewing with a leading Indian tech startup.</small></p></li><li data-reactid="46"><a href="/blog/2016-music-in-review/" data-reactid="47">2016 Music in Review</a><!-- react-text: 48 --> ¬∑ <!-- /react-text --><small data-reactid="49">2 min read</small><p data-reactid="50"><small data-reactid="51">A round up of the seven best artists, both old and new, that I discovered in 2016.</small></p></li></ul></article><hr data-reactid="52"/><div class="bio" data-reactid="53"><img class="avatar" alt="avatar" src="/38efebf2bc5832b39113314d2fd9cc07.jpg" data-reactid="54"/><p class="intro" data-reactid="55"><!-- react-text: 56 -->Written by <!-- /react-text --><a href="/about/" data-reactid="57">Siddharth Jain</a><!-- react-text: 58 --> ‚Äî an open source developer interested in minimal design, advanced JavaScript and everything Œª. He is currently <!-- /react-text --><a href="/hire/" data-reactid="59">available</a><!-- react-text: 60 --> for contract development on a project basis.<!-- /react-text --></p></div></aside></section><footer data-reactid="61"><section data-reactid="62"><ul data-reactid="63"><li data-reactid="64"><a rel="noopener noreferrer" target="__blank" href="//yuppi.es/atom" data-reactid="65"><span class="footer-icon" style="background-image:url(/icons/rss.svg);" data-reactid="66"></span></a></li><li data-reactid="67"><a rel="noopener noreferrer" target="__blank" href="//facebook.com/f0rr0" data-reactid="68"><span class="footer-icon" style="background-image:url(/icons/facebook.svg);" data-reactid="69"></span></a></li><li data-reactid="70"><a rel="noopener noreferrer" target="__blank" href="//twitter.com/f0rr0" data-reactid="71"><span class="footer-icon" style="background-image:url(/icons/twitter.svg);" data-reactid="72"></span></a></li><li data-reactid="73"><a rel="noopener noreferrer" target="__blank" href="//github.com/f0rr0" data-reactid="74"><span class="footer-icon" style="background-image:url(/icons/github.svg);" data-reactid="75"></span></a></li><li data-reactid="76"><a rel="noopener noreferrer" target="__blank" href="//linkedin.com/in/f0rr0" data-reactid="77"><span class="footer-icon" style="background-image:url(/icons/linkedin.svg);" data-reactid="78"></span></a></li><li data-reactid="79"><a rel="noopener noreferrer" target="__blank" href="//medium.com/@f0rr0" data-reactid="80"><span class="footer-icon" style="background-image:url(/icons/medium.svg);" data-reactid="81"></span></a></li><li data-reactid="82"><a rel="noopener noreferrer" target="__blank" href="//open.spotify.com/user/sidjain95" data-reactid="83"><span class="footer-icon" style="background-image:url(/icons/spotify.svg);" data-reactid="84"></span></a></li><li data-reactid="85"><a rel="noopener noreferrer" target="__blank" href="//www.last.fm/user/sidjain26" data-reactid="86"><span class="footer-icon" style="background-image:url(/icons/lastfm.svg);" data-reactid="87"></span></a></li></ul></section></footer></main></div><script async="" src="/bundle.js?t=1487572581156"></script><script async="">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-84957482-1', 'auto'); ga('send', 'pageview');</script></body></html>